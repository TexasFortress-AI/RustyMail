

Use terminal tool for rust cargo commands.

Tests: Integration tests should never use mocks

START SPECIFICATION:
# main-overview

## Development Guidelines

- Only modify code directly relevant to the specific request. Avoid changing unrelated functionality.
- Never replace code with placeholders like `# ... rest of the processing ...`. Always include complete code.
- Break problems into smaller steps. Think through each step separately before implementing.
- Always provide a complete PLAN with REASONING based on evidence from code and logs before making changes.
- Explain your OBSERVATIONS clearly, then provide REASONING to identify the exact issue. Add console logs when needed to gather more information.


RustyMail is a high-performance IMAP API server implementing the following core business capabilities:

### Core Email Management
- Multiple interface support: REST API, MCP Stdio, MCP SSE
- Full IMAP folder and message operations 
- Email search with complex criteria
- Flag management and email movement between folders
- Real-time updates via Server-Sent Events (SSE)

### Key Components:

1. IMAP Session Management (`src/imap/session.rs`)
- Session abstraction for IMAP operations
- Custom search criteria transformation
- Email metadata and content fetching
- Flag and folder operation handling

2. MCP Protocol Implementation (`src/api/mcp.rs`) 
- JSON-RPC 2.0 compliant interface
- Custom IMAP operation tools
- Support for stdio and SSE transports
- Error mapping between IMAP and JSON-RPC

3. SSE Real-time Updates (`src/api/sse.rs`)
- Client registration and tracking
- Message broadcasting system
- Heartbeat mechanism
- Session cleanup handling

4. REST API Interface (`src/api/rest.rs`)
- IMAP operation endpoints
- Folder prefix handling
- Email body conditional fetching
- Custom error mapping

### Code Conventions

#### IMAP Operations
- MUST: Use `async-imap` for all IMAP interactions
- AVOID: Direct socket connections or custom IMAP implementations
- WHY: Ensures protocol compliance and security
- EXAMPLE: `src/imap/client.rs`

#### Error Handling
- MUST: Map domain errors to appropriate HTTP/JSON-RPC codes
- AVOID: Generic error responses without context
- WHY: Provides clear error feedback to clients
- EXAMPLE: `src/api/rest.rs` error mapping

#### Message Processing
- MUST: Handle both text and HTML email bodies
- AVOID: Assuming single content type
- WHY: Supports all email formats
- EXAMPLE: `src/imap/types.rs`

#### Real-time Updates
- MUST: Use SSE for live notifications
- AVOID: Polling or websockets
- WHY: Efficient server-push updates
- EXAMPLE: `src/api/sse.rs`

$END$
END SPECIFICATION