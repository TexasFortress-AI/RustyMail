START SPECIFICATION:
# main-overview

## Development Guidelines

- Only modify code directly relevant to the specific request. Avoid changing unrelated functionality.
- Never replace code with placeholders like `# ... rest of the processing ...`. Always include complete code.
- Break problems into smaller steps. Think through each step separately before implementing.
- Always provide a complete PLAN with REASONING based on evidence from code and logs before making changes.
- Explain your OBSERVATIONS clearly, then provide REASONING to identify the exact issue. Add console logs when needed to gather more information.


RustyMail is a high-performance IMAP API server providing multiple interfaces (REST, MCP Stdio, MCP SSE) for accessing email services. The core business logic is organized around several key components:

### Core Components and Domain Logic

1. IMAP Session Management (`src/imap/session.rs`, Score: 95)
- Atomic email movement between folders with integrity checks
- Folder synchronization and status tracking 
- Server-side search optimization with criteria transformation
- Flag operation handling with IMAP STORE commands

2. MCP Protocol Implementation (`src/api/mcp.rs`, Score: 90) 
- JSON-RPC 2.0 compliant request/response handling
- Transport abstraction for stdio and SSE interfaces
- Domain error mapping to standardized error codes

3. Email and Folder Models (`src/imap/types.rs`, Score: 85)
- Custom email structure with IMAP-specific metadata
- Folder hierarchy management with delimiter support
- Search criteria modeling for complex queries
- Flag operation state transitions

4. Real-time Updates via SSE (`src/api/sse.rs`, Score: 80)
- Client registration and lifecycle management
- Event broadcasting system for push updates
- Heartbeat mechanism for connection maintenance

### Code Conventions

#### IMAP Operations
- MUST: Use atomic operations for email moves and flag changes
- AVOID: Direct folder manipulation without status checks
- WHY: Prevents data corruption from race conditions
- EXAMPLE: `src/imap/session.rs:move_email()`

#### MCP Protocol
- MUST: Follow JSON-RPC 2.0 spec for all MCP communication
- AVOID: Custom message formats or non-standard error codes
- WHY: Ensures protocol compliance and interoperability
- EXAMPLE: `src/api/mcp.rs:handle_request()`

#### Email Processing
- MUST: Validate all email attributes before operations
- AVOID: Assumptions about message structure or encoding
- WHY: Handles diverse email formats reliably
- EXAMPLE: `src/imap/types.rs:Email`

#### Real-time Updates
- MUST: Use SSE for live notifications
- AVOID: Polling or websockets
- WHY: Efficient server-push updates
- EXAMPLE: `src/api/sse.rs:broadcast_event()`

$END$
END SPECIFICATION