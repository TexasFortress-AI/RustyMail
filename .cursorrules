START SPECIFICATION:
---
description: Generate high-level overview documentation focused on core business logic, domain models, and unique workflows when analyzing multiple source files that comprise a complete software system
globs: 
alwaysApply: false
---


# main-overview

## Development Guidelines

- Only modify code directly relevant to the specific request. Avoid changing unrelated functionality.
- Never replace code with placeholders like `# ... rest of the processing ...`. Always include complete code.
- Break problems into smaller steps. Think through each step separately before implementing.
- Always provide a complete PLAN with REASONING based on evidence from code and logs before making changes.
- Explain your OBSERVATIONS clearly, then provide REASONING to identify the exact issue. Add console logs when needed to gather more information.


RustyMail implements a high-performance IMAP server with multiple client interfaces (REST, MCP Stdio, MCP SSE). The core business logic is organized around these key components:

## IMAP Session Management
- Manages concurrent IMAP client sessions through a factory pattern
- Handles session lifecycle including connection, authentication, and cleanup
- Implements atomic operations for moving emails and updating flags
- Located in `src/imap/session.rs`

## Mail Control Protocol (MCP) 
- JSON-RPC 2.0 compliant protocol for IMAP operations
- Supports multiple transports: stdio and SSE
- Implements domain-specific error codes for IMAP operations
- Defined in `src/mcp/handler.rs` and `src/mcp/types.rs`

## Email Domain Model
- Represents emails with UID, flags, envelope data
- Implements mailbox information tracking
- Provides search criteria model for complex queries
- Defined in `src/imap/types.rs`

## Real-time Updates
- SSE-based broadcasting of mailbox changes
- Client tracking and event distribution
- Connection lifecycle management
- Implemented in `src/api/sse.rs`

## Business Operations
Key workflows include:
- Atomic email movement between folders
- Flag state management
- Folder synchronization
- Search operations
- Email appending with flag preservation

## Error Handling
Domain-specific error hierarchy:
- IMAP protocol errors
- Authentication failures
- Connection issues
- Operation timeouts
- Defined in `src/mcp/error_codes.rs`

The system uses a layered architecture with the IMAP client at the core, wrapped by the MCP protocol layer, and exposed through multiple transport interfaces. All business operations maintain ACID properties through atomic IMAP commands.

$END$
END SPECIFICATION