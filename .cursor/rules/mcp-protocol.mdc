# mcp-protocol

### Transport Layer Implementation
- MUST: Use JSON-RPC 2.0 format for all MCP messages 
- MUST: Handle error codes in range -32000 to -32099 for domain errors
- AVOID: Custom message formats outside JSON-RPC spec
- WHY: Ensures consistent protocol handling across transports
- EXAMPLE: `src/api/mcp.rs` request format:
```json
{
  "jsonrpc": "2.0", 
  "id": "unique-id",
  "method": "imap/listFolders",
  "params": {}
}
```

### Error Code Management
- MUST: Map IMAP errors to domain-specific codes:
  - -32000: IMAP connection errors
  - -32001: Authentication failures  
  - -32002: Folder not found
  - -32003: Folder exists
  - -32004: Email not found
- AVOID: Generic error codes for domain-specific failures
- WHY: Provides clear error context for clients
- EXAMPLE: `src/api/mcp.rs` error handler

### State Management
- MUST: Maintain IMAP session state per connection using Arc<Mutex>
- MUST: Handle connection drops with cleanup
- AVOID: Global state for session data
- WHY: Ensures thread-safe concurrent access
- EXAMPLE: `src/transport.rs` connection handling

### Method Implementation
- MUST: Support core IMAP operations:
  - imap/listFolders
  - imap/createFolder
  - imap/deleteFolder 
  - imap/renameFolder
  - imap/searchEmails
  - imap/fetchEmails
  - imap/moveEmail
- AVOID: Non-standard method names
- WHY: Maintains consistent API surface
- EXAMPLE: `src/api/mcp.rs` method handlers

### Transport Types
- MUST: Implement both stdio and SSE transports
- MUST: Use event streams for SSE notifications
- AVOID: Mixed transport types in single connection
- WHY: Provides flexibility for different client types
- EXAMPLE: `src/transport.rs` transport implementations

### Session Lifecycle
- MUST: Track client connection state
- MUST: Implement 10s heartbeat for SSE
- MUST: Clean up resources on disconnect
- AVOID: Leaked connections
- WHY: Maintains system stability
- EXAMPLE: `src/api/sse.rs` connection handling

$END$