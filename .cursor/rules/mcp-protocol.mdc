---
description: Specifies the Model Context Protocol (MCP) implementation for JSON-RPC messaging over stdio and SSE transports
globs: ["src/mcp/**", "src/api/mcp*", "src/transport*"]
alwaysApply: false
---


# mcp-protocol

### Core Protocol Components

1. **Message Format**
- Implements JSON-RPC 2.0 message format for all MCP communications
- Defines request/response structures with required fields:
  - jsonrpc: Must be "2.0"  
  - id: Unique request identifier
  - method: Target method name (e.g. "imap/listFolders")
  - params: Method parameters object
  - result/error: Response payload

2. **Error Handling**
- Defines standardized error codes:
  - -32700: Parse error
  - -32600: Invalid request
  - -32601: Method not found 
  - -32602: Invalid params
  - -32603: Internal error
  - -32000 to -32099: IMAP-specific errors

3. **Transport Implementations**

Stdio Transport:
- Reads JSON-RPC messages line-by-line from stdin
- Writes responses to stdout
- Supports synchronous request/response pattern

SSE Transport:
- Maintains persistent SSE connections with clients
- Broadcasts messages to all connected clients
- Supports asynchronous events and notifications
- Implements client registration/deregistration

4. **State Management**
- Tracks active SSE clients with unique IDs
- Maintains folder selection state between commands
- Handles client disconnections and cleanup

5. **Method Registry**
- Registers supported MCP methods:
  - imap/listFolders
  - imap/createFolder
  - imap/deleteFolder 
  - imap/renameFolder
  - imap/searchEmails
  - imap/fetchEmails
  - imap/moveEmail

File paths:
- src/mcp/error_codes.rs
- src/mcp/handler.rs
- src/mcp/types.rs
- src/api/mcp_sse.rs
- src/api/mcp_stdio.rs

$END$