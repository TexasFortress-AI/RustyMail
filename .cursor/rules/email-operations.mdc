# email-operations

### Email Movement Operations
- MUST: Use atomic move operations between folders via AsyncImapSession
- AVOID: Moving emails without checking folder existence first
- WHY: Maintains data integrity during email transfers 
- EXAMPLE: `src/imap/session.rs`
```rust
pub async fn move_email(&mut self, uids: &[u32], from: &str, to: &str) -> Result<()> {
    self.select_folder(from).await?;
    self.copy_messages(uids, to).await?;
    self.delete_messages(uids).await?;
    self.expunge().await?;
}
```

### Folder Synchronization
- MUST: Implement folder status checks before operations
- AVOID: Direct folder manipulation without status verification
- WHY: Prevents data corruption from race conditions
- EXAMPLE: `src/imap/session.rs::select_folder()`

### Search Implementation
- MUST: Use async-imap's native search capabilities with transformed criteria
- AVOID: Client-side email filtering
- WHY: Leverages server-side optimizations
- EXAMPLE: `src/imap/session.rs::format_search_criteria()`

### Session State Management
- MUST: Track folder selection state via ImapSession wrapper
- AVOID: Global session state or unmanaged connections
- WHY: Ensures consistent session handling
- EXAMPLE: `src/imap/session.rs::AsyncImapSessionWrapper`

### Atomic Flag Operations
- MUST: Implement store_flags using STORE command
- AVOID: Multiple separate flag operations
- WHY: Maintains atomic guarantees for flag updates
- EXAMPLE: `src/imap/session.rs::store_flags()`

Testing Requirements:
1. Unit tests for each atomic operation
2. Integration tests for multi-step workflows
3. Error handling tests for connection failures
4. Concurrent operation tests
5. Session state verification tests

Importance Scores:
- Email Movement: 95 (core business operation)
- Folder Sync: 90 (data integrity critical)
- Search: 85 (key business functionality)
- Session State: 90 (operational integrity)
- Flag Operations: 85 (core metadata management)

$END$