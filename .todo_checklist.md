# RustyMail - Compilation Error Checklist

## Phase 1: Dependencies and Basic Setup

- [ ] **Add Missing Crates:**
  - [ ] Add `tracing` crate dependency (`cargo add tracing`). (Error E0432 in `mcp_stdio.rs`)
- [ ] **Fix Basic Imports:**
  - [ ] Import IO extension traits (`AsyncBufReadExt`, `AsyncWriteExt`) in `src/api/mcp_stdio.rs`. (Errors E0599)
  - [ ] Import `warn!` macro from `log` crate where needed (e.g., `mcp_sse.rs`). (Error: cannot find macro `warn`)

## Phase 2: Module Structure & Visibility

- [ ] **Resolve Module Paths:**
  - [ ] Fix `api::mcp` path in `src/api/rest.rs`. (Error E0433)
  - [ ] Fix `imap::session_manager` path in `src/api/rest.rs`. (Error E0432)
  - [ ] Fix `mcp_port` path resolution (`mcp/adapters/sdk.rs`, `lib.rs`). (Errors E0432)
  - [ ] Fix `crate::transport` path in `src/transport_test.rs`. (Error E0432)
- [ ] **Fix Type Visibility/Imports:**
  - [ ] Correct import for `actix_web::{App, HttpServer}` in `src/api/mcp_sse.rs`. (Error E0432)
  - [ ] Resolve `SseState` import/type in `src/api/rest.rs`. (Error E0412)

## Phase 3: Duplicate Definitions

- [ ] **Resolve Duplicate Types/Imports:**
  - [x] Fix duplicate definition of `Arc` in `src/api/mcp_stdio.rs`. (Error E0252)
  - [x] Fix duplicate definition of `AppState` in `src/api/rest.rs`. (Error E0255)
  - [ ] Fix duplicate import of `web` in `src/api/mcp_sse.rs`. (Error E0252)
  - [ ] Fix duplicate definition of `StoreOperation` (`imap/session.rs` imports from `imap/types.rs` then redefines). (Error E0255)
- [ ] **Resolve Duplicate Methods:**
  - [ ] Fix duplicate definition of `append` in `src/imap/session.rs`. (Error E0201)

## Phase 4: Core Type Definitions and Trait Implementations

- [ ] **Fix Lifetime Issues:**
  - [ ] Add lifetime parameter to `Flag` type alias in `src/imap/session.rs`. (Error E0106, E0107)
- [ ] **Fix Missing `async_imap` / `imap_types` Items:**
  - [ ] Resolve missing `fetch::Attribute` import (`imap/client.rs`, `imap/session.rs`). (Errors E0432)
  - [ ] Resolve missing `UidPlus`, `MailboxDatum`, `Status` imports in `src/imap/session.rs`. (Errors E0432)
  - [ ] Resolve missing `Envelope`, `Address` from `async_imap::types` in `src/imap/session.rs`, `src/imap/types.rs`. (Errors E0412)
  - [ ] Resolve missing `MailboxData` from `async_imap::types` in `src/imap/types.rs`. (Error E0412)
  - [ ] Resolve missing `UidSet`, `StoreType`, `StatusDataItem` from `async_imap::types` (likely in `imap/session.rs` mock impl). (Errors E0412)
- [ ] **Fix Missing Trait Implementations:**
  - [ ] Implement `AsyncBufReadExt` for `BufReader<Stdin>` if needed (see IO trait imports).
  - [ ] Implement `AsyncWriteExt` for `BufWriter<Stdout>` if needed (see IO trait imports).
  - [ ] Implement `AsyncImapOps` for `AsyncImapSessionWrapper` in `src/imap/client.rs`. (Error E0277)
  - [ ] Implement `From<io::Error>` for `ImapError` or fix `?` usage in `src/imap/client.rs`. (Error E0277)
  - [ ] Implement `From<imap::types::ImapError>` for `imap::error::ImapError` or fix `?` usage in `src/imap/session.rs`. (Error E0277)
  - [ ] Implement `FromStr` for `imap::types::Flags`. (Error E0277 in `rest.rs`)
  - [ ] Implement `Try` for `HttpResponse` or fix `?` usage in `src/api/mcp_sse.rs`. (Error E0277)
  - [ ] Implement `Serialize` for `mpsc::Sender<sse::Event>` (or avoid deriving Serialize) in `src/api/mcp_sse.rs`. (Error E0277)
  - [ ] Implement `Debug` for `ImapSessionFactory` type alias (function pointer) or avoid deriving Debug where it's used (`mcp/adapters/sdk.rs`). (Error E0277)
  - [ ] Implement `ImapSession` for `MockMockImapSession` in `src/api/rest.rs` tests. (Error E0277)
  - [ ] Implement `McpHandler` for `MockMockMcpHandler` in `src/api/rest.rs` tests. (Error E0277)
- [ ] **Fix Basic Type Resolution:**
  - [ ] Resolve `Compat` type in `src/imap/session.rs`. (Error E0412)
  - [ ] Resolve `TokioTlsStream`, `TokioTcpStream` types in `src/imap/session.rs`. (Error E0412)

## Phase 5: Method Signature & Call Errors

- [ ] **Fix Method Argument Mismatches:**
  - [ ] Correct arguments for `session.fetch_emails` call in `src/api/rest.rs`. (Error E0061, E0308)
  - [ ] Correct arguments for `session.store_flags` call in `src/api/rest.rs`. (Error E0061, E0308)
  - [ ] Correct arguments for `session.append` call in `src/imap/client.rs`. (Error E0061)
  - [ ] Correct arguments for `session.append` call in `src/imap/session.rs` (mock impl). (Error E0061)
  - [ ] Correct arguments for `AiService::new` call in `src/dashboard/services/mod.rs`. (Error E0308)
  - [ ] Correct arguments for `MetricsService::new` call in `src/dashboard/services/mod.rs`. (Error E0308)
- [ ] **Fix Missing Methods:**
  - [ ] Remove calls to non-existent `session.move_emails` (use `move_email`) in `src/api/rest.rs`. (Error E0599)
  - [ ] Remove calls to non-existent `session.get_folder_status` in `src/api/rest.rs`. (Error E0599)
  - [ ] Remove call to non-existent `guard.current_folder()` in `src/imap/client.rs`. (Error E0599)
  - [ ] Remove calls to non-existent `Sse::from_custom_stream` (use `from_stream`) in `src/api/sse.rs`, `src/api/mcp_sse.rs`. (Error E0599)
- [ ] **Fix Trait Method Implementation Conflicts:**
  - [ ] Remove methods from `MockAsyncImapOps` impl that are not part of `AsyncImapOps` trait (`list`, `create`, `delete`, etc.) in `src/imap/session.rs`. (Errors E0407)
- [ ] **Fix Other Call Errors:**
  - [ ] Fix `map` call on non-iterator `mpsc::Receiver` in `src/api/mcp_sse.rs`. (Error E0599)
  - [ ] Fix `Into<ByteString>` issue for `format!` result in `src/api/sse.rs`. (Error E0277)
  - [ ] Fix `Into<sse::Data>` issue for `String` in `src/api/mcp_sse.rs`. (Error E0277)
  - [ ] Fix type mismatch in `McpSseServer::new` call in `src/api/mcp_sse.rs` (Arc vs Arc<Mutex>). (Error E0308)
  - [ ] Fix `map_err(JsonRpcError::from_imap_error)` signature mismatch in `src/mcp_port.rs`. (Error E0631)

## Phase 6: Field Access & Struct Definitions

- [ ] **Fix Field Access Errors:**
  - [ ] Correct field names used for `AppendEmailPayload` in `src/api/rest.rs`. (Error E0560, E0609)
  - [ ] Correct field names used for `MailboxInfo` in `src/imap/session.rs`. (Error E0560)
  - [ ] Correct field access `fetch.internal_date` (method call) in `src/imap/types.rs`. (Error E0615)
  - [ ] Fix access to `DashboardConfig::metrics_interval` in `src/dashboard/services/mod.rs`. (Error E0609)
  - [ ] Fix access to `config.ai` in `src/dashboard/services/mod.rs`. (Error E0609)
  - [ ] Fix access to `context.port_state.lock()` (should be Mutex) in `src/mcp/adapters/sdk.rs`. (Error E0599)
  - [ ] Fix access to `context.session_factory()` (field vs method call) in `src/mcp/adapters/sdk.rs`. (Error E0599)
  - [ ] Fix `p.flags.is_empty()` call (field missing) in `src/mcp_port.rs`. (Error E0599)
- [ ] **Fix Struct/Enum Definitions:**
  - [ ] Fix missing `Flags::from_str` in `src/api/rest.rs` (add derive or impl). (Covered by Trait Implementations)
  - [ ] Fix missing `Default` for `AiService` or use `::new()` in `src/dashboard/services/mod.rs`. (Error E0599)
  - [ ] Fix missing variants/associated items for `ImapError` enum used in `src/api/rest.rs` match. (Errors E0599)
  - [ ] Fix missing variants/associated items for `async_imap::error::Error` enum used in `src/imap/error.rs`. (Errors E0599)
  - [ ] Fix missing variants/associated items for `SearchCriteria` enum used in `src/mcp_port.rs`. (Error E0599)
  - [ ] Fix `to_string` calls on types without `Display` (`NameAttribute`, `async_imap::types::Flag`, `Cow<'_, [u8]>`) in `src/imap/types.rs`. (Errors E0599)

## Phase 7: Mocking and Test Setup

- [ ] **Fix Mock Definitions/Imports:**
  - [ ] Resolve `MockAsyncImapOps` import in `src/imap/client_test.rs`. (Error E0432)
  - [ ] Resolve `MockMcpHandler` import/definition in `src/api/mcp_stdio.rs`. (Error E0412, E0433)
  - [ ] Resolve `MockMcpHandler` trait bounds in `src/api/rest.rs`. (Error E0277)
- [ ] **Fix Test Type Mismatches:**
  - [ ] Fix `ImapClient: ImapSession` trait bound issue in `src/mcp/adapters/legacy.rs` test context. (Error E0277)
  - [ ] Fix `Arc<dyn Fn() ...>: Sized` bound issue for `Arc::new()` in `src/mcp/adapters/sdk.rs` test context. (Error E0599)

## Phase 8: Cleanup and Warnings

- [ ] **Address Compiler Warnings:**
  - [ ] Remove all unused imports identified by `cargo test`.
  - [ ] Remove `mut` from unused mutable variable in `src/api/rest.rs`.
  - [ ] Update `Last Updated` field in this checklist.
  - [ ] Update `Progress Tracking` counts in this checklist.

## Phase 9: Testing Infrastructure (From Original Checklist)

- [ ] **Organize Test Modules:**
  - [ ] Move test files to appropriate locations (e.g., ensure `client_test.rs` is under `#[cfg(test)] mod tests { ... }`).
  - [ ] Add missing test modules if needed.
  - [ ] Update test imports after moving files.
- [ ] **Add Missing Tests:**
  - [ ] Add integration tests for key flows (e.g., REST API calls, MCP interactions).
  - [ ] Add unit tests for newly refactored logic (e.g., error mapping, helpers).
  - [ ] Add tests specifically covering error cases for handlers and session methods.
