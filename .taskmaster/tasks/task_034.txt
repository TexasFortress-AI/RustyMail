# Task ID: 34
# Title: Migrate MCP server from deprecated SSE transport to modern Streamable HTTP transport
# Status: pending
# Dependencies: 8, 32
# Priority: high
# Description: Replace the current SSE-based MCP implementation with the new Streamable HTTP transport protocol using a single bidirectional /mcp endpoint to comply with 2025 MCP specification updates.
# Details:
Replace the deprecated SSE-based MCP transport implementation in src/api/mcp_sse_real.rs with the modern Streamable HTTP transport as required by MCP specification version 2025-03-26. Create a new single HTTP endpoint at /mcp that supports both GET and POST methods for bidirectional communication. The POST method should handle JSON-RPC requests/responses/notifications with Accept headers supporting both application/json and text/event-stream. The GET method should provide optional SSE streaming capability. Implement proper session management using Mcp-Session-Id headers, connection resumability with Last-Event-ID support, and Origin header validation for DNS rebinding protection. Remove the separate /sse and /message endpoints and consolidate into the single /mcp endpoint pattern. Update all MCP client interfaces to use the new /mcp/v1 route structure. Ensure UTF-8 encoded JSON-RPC message handling and maintain backward compatibility during the transition period. Add proper error handling for the unified connection model and implement resumption token support for reliable network conditions.

# Test Strategy:
Create integration tests that verify the new /mcp endpoint responds correctly to both GET and POST requests. Test JSON-RPC request/response cycles through the POST method with proper Accept headers. Verify SSE streaming works through the GET method with text/event-stream. Test session management by creating sessions and verifying Mcp-Session-Id header handling. Test connection resumability using Last-Event-ID to replay missed messages. Verify Origin header validation prevents DNS rebinding attacks. Create comprehensive MCP tool tests using the new endpoint structure (replacing the current /mcp/v1 route expectations). Test backward compatibility if maintaining both transport methods during transition. Performance test the unified connection model compared to the separate SSE/message endpoint approach.

# Subtasks:
## 1. Remove deprecated SSE transport implementation [done]
### Dependencies: None
### Description: Remove the existing SSE-based MCP transport implementation from src/api/mcp_sse_real.rs and clean up related deprecated endpoints (/sse and /message)
### Details:
Delete src/api/mcp_sse_real.rs file and remove all references to the deprecated SSE transport. Clean up routing for /sse and /message endpoints. Remove any SSE-specific configuration and middleware. Update imports and dependencies to remove SSE transport references.

## 2. Implement unified /mcp endpoint with dual method support [done]
### Dependencies: 34.1
### Description: Create a new single HTTP endpoint at /mcp that supports both GET and POST methods for bidirectional MCP communication
### Details:
Implement a new endpoint handler that accepts both GET and POST requests at /mcp. POST method should handle JSON-RPC requests/responses/notifications with proper Accept header parsing (application/json and text/event-stream). GET method should provide SSE streaming capability. Ensure proper HTTP method routing and request validation.
<info added on 2025-10-02T13:54:26.781Z>
I'll analyze the codebase to understand the current implementation and provide relevant details for this subtask update.Implementation completed with full Streamable HTTP transport functionality. Created comprehensive src/api/mcp_http.rs module implementing both POST and GET handlers for /mcp and /mcp/v1 endpoints. POST handler processes JSON-RPC requests with proper Accept header parsing supporting both application/json and text/event-stream responses. GET handler provides SSE streaming with session management, heartbeat functionality, and proper connection lifecycle. Successfully integrated tools (list_folders, search_emails, fetch_emails_with_mime) with initialize method returning session ID and protocol version 2025-03-26. Deprecated SSE transport code removed from mcp_sse_real.rs and route configuration updated in main.rs:246. Both endpoints tested and fully operational for MCP client connections.
</info added on 2025-10-02T13:54:26.781Z>

## 3. Implement session management and security features [pending]
### Dependencies: 34.2
### Description: Add session management using Mcp-Session-Id headers, Origin header validation for DNS rebinding protection, and connection resumability support
### Details:
Implement session tracking using Mcp-Session-Id headers for connection persistence. Add Origin header validation to prevent DNS rebinding attacks. Implement connection resumability with Last-Event-ID support for reliable network conditions. Add proper session lifecycle management and cleanup. Ensure localhost binding for local development security.

## 4. Update MCP client interfaces for new endpoint structure [pending]
### Dependencies: 34.3
### Description: Migrate all MCP client interfaces to use the new /mcp endpoint structure and update routing to /mcp/v1 pattern
### Details:
Update all client-side MCP interfaces to connect to the new /mcp endpoint instead of separate /sse and /message endpoints. Implement /mcp/v1 routing structure for API versioning. Update client connection logic to handle the unified endpoint model. Ensure proper error handling for the new connection pattern.

## 5. Implement comprehensive testing and validation [pending]
### Dependencies: 34.4
### Description: Create integration tests for the new Streamable HTTP transport and ensure compliance with MCP specification version 2025-03-26
### Details:
Create comprehensive integration tests that verify the new /mcp endpoint responds correctly to both GET and POST requests. Test JSON-RPC request/response cycles through POST method with proper Accept headers. Verify SSE streaming works through GET method with text/event-stream. Test session management, connection resumability, and security features. Ensure UTF-8 encoded JSON-RPC message handling and specification compliance.

