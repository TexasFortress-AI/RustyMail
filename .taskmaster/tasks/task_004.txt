# Task ID: 4
# Title: Implement atomic IMAP operations
# Status: done
# Dependencies: 3
# Priority: high
# Description: Ensure all email operations follow atomic patterns (select → copy → delete → expunge)
# Details:
Implement atomic move operations using IMAP command sequence: SELECT source folder, COPY messages to destination, STORE delete flag on source messages, EXPUNGE to remove. Ensure all operations maintain ACID properties. Add proper error handling and rollback mechanisms. Track folder selection state in AsyncImapSessionWrapper.

# Test Strategy:
Test atomic operations with mock IMAP server. Verify partial failures are handled correctly. Test concurrent access scenarios. Ensure no message loss during operations.

# Subtasks:
## 1. Design atomic IMAP move operation sequence [done]
### Dependencies: None
### Description: Define the precise IMAP command sequence for atomic move operations, ensuring compliance with IMAP4rev1/IMAP4rev2 standards and ACID properties.
### Details:
Specify the order and logic for SELECT, COPY, STORE (delete flag), and EXPUNGE commands. Ensure the sequence prevents message loss and maintains consistency.

## 2. Implement error handling and rollback mechanisms [done]
### Dependencies: 4.1
### Description: Develop robust error detection and rollback logic to maintain atomicity and consistency in case of partial failures during IMAP operations.
### Details:
Ensure that any failure in the command sequence triggers rollback or compensating actions to restore the previous state and prevent data corruption.

## 3. Track folder selection state in AsyncImapSessionWrapper [done]
### Dependencies: 4.1
### Description: Add logic to accurately track and manage the selected folder state within AsyncImapSessionWrapper to support atomic operations.
### Details:
Ensure the session wrapper maintains correct folder context across concurrent and sequential operations, preventing state mismatches.

## 4. Integrate ACID property enforcement for IMAP operations [done]
### Dependencies: 4.2, 4.3
### Description: Implement mechanisms to guarantee atomicity, consistency, isolation, and durability for all IMAP move operations.
### Details:
Use transaction-like logic to ensure operations are all-or-nothing, isolated from other concurrent actions, and changes are durable.

## 5. Develop comprehensive test suite for atomic IMAP operations [done]
### Dependencies: 4.4
### Description: Create automated tests to validate atomicity, error handling, rollback, ACID compliance, and folder state tracking for IMAP operations.
### Details:
Include tests for partial failures, concurrent access, and edge cases to ensure reliability and correctness.

